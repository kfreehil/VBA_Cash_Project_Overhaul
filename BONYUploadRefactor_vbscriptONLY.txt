'====================================================================================================
'============BELOW CODE SITS WITHIN A VB SCRIPT OUTSIDE ACCESS DATABASE "BONYNostro.accdb"===========
'====================================================================================================
'
' USAGE:
'   Normal run:        wscript BONYUpload.vbs
'   Force maintenance: wscript BONYUpload.vbs /force
'
'====================================================================================================

Option Explicit

'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' GLOBAL VARIABLES
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Dim g_LogFile       ' Log file path
Dim g_fso           ' FileSystemObject (global for logging)
Dim g_LogStream     ' Log file stream
Dim g_DataDir       ' Data directory path
Dim g_ForceMaintenance  ' Force maintenance flag

'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' 32/64 BIT CHECK
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Dim ScriptHost
ScriptHost = Mid(WScript.FullName, InStrRev(WScript.FullName, "\") + 1, Len(WScript.FullName))

Dim oWs : Set oWs = CreateObject("WScript.Shell")
Dim oProcEnv : Set oProcEnv = oWs.Environment("Process")

If InStr(LCase(WScript.FullName), LCase(oProcEnv("windir") & "\System32\")) And oProcEnv("PROCESSOR_ARCHITECTURE") = "AMD64" Then
    If Not WScript.Arguments.Count = 0 Then
        Dim sArg, Arg
        sArg = ""
        For Each Arg In Wscript.Arguments
            sArg = sArg & " " & """" & Arg & """"
        Next
    End If
    Dim sCmd : sCmd = """" & oProcEnv("windir") & "\SysWOW64\" & ScriptHost & """" & " """ & WScript.ScriptFullName & """" & sArg
    oWs.Run sCmd
    WScript.Quit
End If

'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' CONFIGURATION
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
g_DataDir = "C:\Users\kfreehil\MyData\"
Const DB_BONY = "BONYNostro.accdb"
Const DB_MANAGER = "Manager.accdb"

'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' CHECK FOR FORCE FLAG
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
g_ForceMaintenance = False

Dim argItem
For Each argItem In WScript.Arguments
    If LCase(argItem) = "/force" Or LCase(argItem) = "-force" Or LCase(argItem) = "--force" Then
        g_ForceMaintenance = True
    End If
Next

'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' MAIN SCRIPT
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Dim StartTime
Dim Elapsed
Dim dbPath

StartTime = Timer
dbPath = g_DataDir & DB_BONY

'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' INITIALIZE LOGGING
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Set g_fso = CreateObject("Scripting.FileSystemObject")
g_LogFile = g_DataDir & "BONYUploadLog.txt"

' Open log file for appending (8 = ForAppending, True = Create if not exists)
Set g_LogStream = g_fso.OpenTextFile(g_LogFile, 8, True)

WriteLog "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
WriteLog "BONY UPLOAD SCRIPT STARTED"
If g_ForceMaintenance Then
    WriteLog "*** FORCE MAINTENANCE MODE ***"
End If
WriteLog "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
WriteLog ""

'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' VALIDATE DATABASE PATH
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
WriteLog "Checking database path..."
WriteLog "  Path: " & dbPath

If Not g_fso.FileExists(dbPath) Then
    WriteLog "  [FATAL ERROR] Database not found!"
    WriteLog "  Please check the path and try again."
    CloseLog
    MsgBox "FATAL ERROR: Database not found at " & dbPath, 16, "BONY Upload Error"
    WScript.Quit 1
End If

WriteLog "  [OK] Database found"
WriteLog ""

'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' DAILY MAINTENANCE (runs ONCE per day, BEFORE opening database)
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Dim maintenanceRan
maintenanceRan = False

If g_ForceMaintenance Then
    WriteLog "Force maintenance requested - running maintenance..."
    PerformDailyMaintenance dbPath
    maintenanceRan = True
ElseIf IsDailyMaintenanceNeeded() Then
    WriteLog "Daily maintenance needed - running maintenance..."
    PerformDailyMaintenance dbPath
    maintenanceRan = True
Else
    WriteLog "Daily maintenance already completed today - skipping"
    WriteLog ""
End If

'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' NORMAL DATA INGESTION
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
WriteLog "Opening Access database for data ingestion..."

Dim AccessDB
Set AccessDB = CreateObject("Access.Application")

On Error Resume Next
AccessDB.OpenCurrentDatabase dbPath

If Err.Number <> 0 Then
    WriteLog "  [ERROR] Failed to open database: " & Err.Description
    CloseLog
    MsgBox "ERROR: Failed to open database - " & Err.Description, 16, "BONY Upload Error"
    WScript.Quit 1
End If
On Error GoTo 0

WriteLog "  [OK] Database opened"
WriteLog "Running IngestNewData..."

On Error Resume Next
AccessDB.Run "IngestNewData", False

If Err.Number <> 0 Then
    WriteLog "  [ERROR] IngestNewData failed: " & Err.Description
Else
    WriteLog "  [OK] IngestNewData completed"
End If
On Error GoTo 0

AccessDB.Quit
Set AccessDB = Nothing

WriteLog ""

'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' MANAGER DATABASE UPDATE
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
WriteLog "Opening Manager database..."

Dim AccessDB2
Set AccessDB2 = CreateObject("Access.Application")

On Error Resume Next
AccessDB2.OpenCurrentDatabase g_DataDir & DB_MANAGER

If Err.Number <> 0 Then
    WriteLog "  [ERROR] Failed to open Manager database: " & Err.Description
Else
    WriteLog "  [OK] Manager database opened"
    WriteLog "Running ConfirmtBony..."
    
    AccessDB2.Run "ConfirmtBony"
    
    If Err.Number <> 0 Then
        WriteLog "  [ERROR] ConfirmtBony failed: " & Err.Description
    Else
        WriteLog "  [OK] ConfirmtBony completed"
    End If
End If
On Error GoTo 0

AccessDB2.Quit
Set AccessDB2 = Nothing

'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' RECORD MAINTENANCE DATE (ensures no duplicate maintenance runs today)
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
If maintenanceRan Then
    SetLastMaintenanceDate
    WriteLog "Maintenance date recorded - will not run again today"
    WriteLog ""
End If

'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' COMPLETE
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Elapsed = Timer - StartTime

WriteLog "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
WriteLog "BONY UPLOAD SCRIPT COMPLETED"
WriteLog "Total time: " & PrintHrMinSec(Elapsed)
WriteLog "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
WriteLog ""
WriteLog ""

CloseLog

MsgBox "BONY Data has been loaded via Outlook!" & vbCrLf & vbCrLf & _
       "Timer: " & PrintHrMinSec(Elapsed) & vbCrLf & _
       "Log: " & g_LogFile, 64, "BONY Upload Complete"


'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' LOGGING FUNCTIONS
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

'**********************
'*** WRITE TO LOG FILE ***
'**********************
Sub WriteLog(message)
    Dim timestamp
    timestamp = FormatDateTime(Now, vbShortDate) & " " & FormatDateTime(Now, vbLongTime)
    
    g_LogStream.WriteLine timestamp & " | " & message
End Sub

'**********************
'*** CLOSE LOG FILE ***
'**********************
Sub CloseLog()
    On Error Resume Next
    g_LogStream.Close
    Set g_LogStream = Nothing
    On Error GoTo 0
End Sub


'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' MAINTENANCE FUNCTIONS
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

'**********************
'*** CHECK IF MAINTENANCE NEEDED ***
'**********************
Function IsDailyMaintenanceNeeded()
    Dim trackingFile
    trackingFile = g_DataDir & "LastMaintenanceDate.txt"
    
    ' File doesn't exist - maintenance needed
    If Not g_fso.FileExists(trackingFile) Then
        IsDailyMaintenanceNeeded = True
        Exit Function
    End If
    
    ' Read last maintenance date
    Dim ts, lastDateStr
    Set ts = g_fso.OpenTextFile(trackingFile, 1) ' 1 = ForReading
    lastDateStr = Trim(ts.ReadLine)
    ts.Close
    
    ' Compare to today
    Dim lastDate
    On Error Resume Next
    lastDate = CDate(lastDateStr)
    If Err.Number <> 0 Then
        ' Invalid date in file - maintenance needed
        Err.Clear
        IsDailyMaintenanceNeeded = True
        Exit Function
    End If
    On Error GoTo 0
    
    If DateValue(lastDate) < DateValue(Now) Then
        IsDailyMaintenanceNeeded = True
    Else
        IsDailyMaintenanceNeeded = False
    End If
End Function

'**********************
'*** SET LAST MAINTENANCE DATE ***
'**********************
Sub SetLastMaintenanceDate()
    Dim trackingFile
    trackingFile = g_DataDir & "LastMaintenanceDate.txt"
    
    Dim ts
    Set ts = g_fso.CreateTextFile(trackingFile, True) ' True = Overwrite
    ts.WriteLine FormatDateTime(Now, vbShortDate)
    ts.Close
    
    WriteLog "  [OK] Last maintenance date set to: " & FormatDateTime(Now, vbShortDate)
End Sub

'**********************
'*** PERFORM DAILY MAINTENANCE ***
'**********************
Sub PerformDailyMaintenance(dbPath)
    WriteLog "==========================================="
    WriteLog "       DAILY MAINTENANCE"
    WriteLog "==========================================="
    WriteLog ""
    
    Dim maintenanceStart
    maintenanceStart = Timer
    
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ' STEP 1: Compact Database (while CLOSED)
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    WriteLog "Step 1: Compacting database..."
    WriteLog "  Database: " & dbPath
    
    Dim tempPath, backupPath
    tempPath = Replace(dbPath, ".accdb", "_temp.accdb")
    backupPath = Replace(dbPath, ".accdb", "_backup.accdb")
    
    ' Get size before
    Dim dbFile, sizeBefore
    Set dbFile = g_fso.GetFile(dbPath)
    sizeBefore = dbFile.Size
    Set dbFile = Nothing
    
    WriteLog "  Size before: " & FormatNumber(sizeBefore / 1024 / 1024, 1) & " MB"
    
    ' Compact using DAO
    Dim engine
    Set engine = CreateObject("DAO.DBEngine.120")
    
    On Error Resume Next
    
    ' Delete temp file if exists
    If g_fso.FileExists(tempPath) Then g_fso.DeleteFile tempPath, True
    
    ' Compact to temp file
    engine.CompactDatabase dbPath, tempPath
    
    If Err.Number = 0 Then
        ' Success - swap files
        If g_fso.FileExists(backupPath) Then g_fso.DeleteFile backupPath, True
        g_fso.MoveFile dbPath, backupPath
        g_fso.MoveFile tempPath, dbPath
        
        Dim sizeAfter
        Set dbFile = g_fso.GetFile(dbPath)
        sizeAfter = dbFile.Size
        Set dbFile = Nothing
        
        WriteLog "  Size after: " & FormatNumber(sizeAfter / 1024 / 1024, 1) & " MB"
        WriteLog "  Saved: " & FormatNumber((sizeBefore - sizeAfter) / 1024 / 1024, 1) & " MB"
        WriteLog "  [OK] Compact complete!"
        
        ' Delete old backup (no longer needed)
        If g_fso.FileExists(backupPath) Then
            g_fso.DeleteFile backupPath, True
            WriteLog "  [OK] Old database backup deleted"
        End If
    Else
        WriteLog "  [ERROR] Compact failed: " & Err.Description
        WriteLog "  [ERROR] Error number: " & Err.Number
        Err.Clear
        If g_fso.FileExists(tempPath) Then g_fso.DeleteFile tempPath, True
    End If
    
    On Error GoTo 0
    Set engine = Nothing
    WriteLog ""
    
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ' STEP 2: Refresh Index
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    WriteLog "Step 2: Refreshing ValueDate index..."
    
    Dim indexStart
    indexStart = Timer
    
    Dim accessApp
    Set accessApp = CreateObject("Access.Application")
    accessApp.OpenCurrentDatabase dbPath
    
    On Error Resume Next
    accessApp.CurrentDb.Execute "DROP INDEX idx_valuedate ON BonyStatement"
    Err.Clear
    On Error GoTo 0
    
    accessApp.CurrentDb.Execute "CREATE INDEX idx_valuedate ON BonyStatement(ValueDate)"
    
    accessApp.Quit
    Set accessApp = Nothing
    
    WriteLog "  Index refreshed in " & FormatNumber(Timer - indexStart, 2) & " seconds"
    WriteLog "  [OK] Index complete!"
    WriteLog ""
    
    WriteLog "==========================================="
    WriteLog "[OK] Daily maintenance complete!"
    WriteLog "  Total time: " & FormatNumber(Timer - maintenanceStart, 1) & " seconds"
    WriteLog "==========================================="
    WriteLog ""
End Sub

'**********************
'*** FORMAT TIME AS HH:MM:SS ***
'**********************
Function PrintHrMinSec(elap)
    Dim hr, min, sec, remainder
    
    elap = Int(elap)
    
    hr = elap \ 3600
    remainder = elap - hr * 3600
    min = remainder \ 60
    remainder = remainder - min * 60
    sec = remainder
    
    If Len(sec) = 1 Then sec = "0" & sec
    If Len(min) = 1 Then min = "0" & min
    
    If hr = 0 Then
        PrintHrMinSec = min & ":" & sec
    Else
        PrintHrMinSec = hr & ":" & min & ":" & sec
    End If
End Function
```

---

## ğŸ“‹ **Key Changes**

### **1. Force Maintenance via Command Line**
```
Normal run (maintenance only if needed):
wscript BONYUpload.vbs

Force maintenance (runs even if already done today):
wscript BONYUpload.vbs /force
wscript BONYUpload.vbs -force
wscript BONYUpload.vbs --force